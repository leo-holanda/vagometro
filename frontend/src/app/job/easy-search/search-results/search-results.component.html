<main class="grid grid-rows-[1fr_auto] px-4 pb-4 w-full">
  <section class="flex flex-col gap-4 my-4 lg:self-start lg:flex-row lg:rounded-lg">
    <button
      class="btn flex-nowrap"
      (click)="setDataType('jobs')"
      [ngClass]="{
        'btn-primary': selectedDataType === 'jobs',
        'btn-outline': selectedDataType !== 'jobs'
      }"
    >
      <i class="bx bxs-briefcase"></i>
      <span> Vagas </span>
    </button>

    <button
      class="btn flex-nowrap"
      (click)="setDataType('stats')"
      [ngClass]="{
        'btn-primary': selectedDataType === 'stats',
        'btn-outline': selectedDataType !== 'stats'
      }"
    >
      <i class="bx bx-stats"></i>
      <span> An√°lise </span>
    </button>

    <button [routerLink]="['/busca-facil/dados']" class="btn flex-nowrap">
      <i class="bx bxs-edit"></i>
      <span class="text-nowrap"> Editar busca </span>
    </button>
  </section>

  <ng-container *ngIf="selectedDataType === 'jobs'">
    <ng-container *ngIf="hasFoundJobs; else emptyResultsTemplate">
      <ng-container *ngIf="!isJobsListEmpty; else emptyJobListTemplate">
        <ng-container *ngIf="matchesMobileBreakpoint$ | async; else desktopTemplate">
          <section class="w-full lg:w-1/2">
            <div class="card card-bordered card-compact bg-base-300 h-fit">
              <div class="card-title justify-between p-4">
                <h1>Vagas encontradas</h1>
                <span>Total: {{ ((filteredJobs$ | async) || []).length }} vagas</span>
              </div>

              <div class="card-body overflow-y-hidden">
                <vgm-job-list [jobs$]="filteredJobs$" [sortBy]="'matchPercentage'"></vgm-job-list>
              </div>
            </div>
          </section>
        </ng-container>
      </ng-container>
    </ng-container>

    <ng-template #emptyResultsTemplate>
      <section class="w-full lg:w-1/2">
        <div class="card card-bordered card-compact bg-base-300">
          <div class="card-body">
            <div class="card-title">
              <span> Nenhuma vaga foi encontrada. </span>
            </div>

            <span>Voc√™ pode tentar:</span>
            <ul class="list-disc list-inside">
              <li>Editar os par√¢metros para ampliar o alcance da busca.</li>
              <li>Utilizar um intervalo de tempo maior caso voc√™ o tenha alterado.</li>
              <li>
                Conferir novamente ap√≥s a pr√≥xima atualiza√ß√£o de vagas. Confira sua contagem
                regressiva no rodap√© da p√°gina.
              </li>
            </ul>
          </div>
        </div>
      </section>
    </ng-template>

    <ng-template #emptyJobListTemplate>
      <section class="w-full lg:w-1/2">
        <div class="card card-bordered card-compact bg-base-300">
          <div class="card-body">
            <div class="card-title">
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <i class="bx bxs-party"></i>
                  <span *ngIf="(selectedJobList$ | async) === jobLists.TO_DECIDE">
                    Voc√™ conferiu todas as vagas encontradas.
                  </span>
                </div>
              </div>

              <span *ngIf="(selectedJobList$ | async) === jobLists.APPLIED">
                N√£o h√° nenhuma vaga aplicada ainda.
              </span>

              <span *ngIf="(selectedJobList$ | async) === jobLists.DISCARDED">
                N√£o h√° nenhuma vaga descartada ainda.
              </span>
            </div>

            <span *ngIf="(selectedJobList$ | async) === jobLists.TO_DECIDE" class="mb-2"
              >Buscar novas oportunidades pode ser algo bastante exaustivo e desgastante, mas voc√™
              est√° fazendo um √≥timo progresso. Parab√©ns e boa sorte! üôè</span
            >

            <div class="card-actions flex flex-col gap-2">
              <button
                *ngIf="(selectedJobList$ | async) !== jobLists.TO_DECIDE"
                class="btn w-full"
                (click)="setJobsListType(jobLists.TO_DECIDE)"
              >
                Ver vagas a decidir
              </button>
              <button
                *ngIf="(selectedJobList$ | async) !== jobLists.APPLIED"
                class="btn w-full"
                (click)="setJobsListType(jobLists.APPLIED)"
              >
                Ver vagas aplicadas
              </button>
              <button
                *ngIf="(selectedJobList$ | async) !== jobLists.DISCARDED"
                class="btn w-full"
                (click)="setJobsListType(jobLists.DISCARDED)"
              >
                Ver vagas descartadas
              </button>
            </div>
          </div>
        </div>
      </section>
    </ng-template>
  </ng-container>

  <ng-container *ngIf="selectedDataType === 'stats'">
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 w-full">
      <div class="lg:col-span-3">
        <vgm-matches-chart [jobs$]="filteredJobs$"></vgm-matches-chart>
      </div>

      <div class="card card-bordered card-compact w-full h-full bg-base-300 lg:col-span-2">
        <div class="card-title items-center p-4">
          <i class="bx bx-line-chart"></i>
          <h1>Vagas publicadas ao longo do tempo</h1>
        </div>

        <div class="card-body">
          <vgm-publication-chart [jobs$]="filteredJobs$"></vgm-publication-chart>
        </div>
      </div>

      <vgm-job-postings-comparison [jobs$]="filteredJobs$"></vgm-job-postings-comparison>

      <vgm-rank [rankType]="rankTypes.experience" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.technology" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.workplace" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.companies" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.inclusion" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.repostings" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.contractTypes" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.education" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.languages" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.cities" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.months" [jobs$]="filteredJobs$"></vgm-rank>

      <vgm-rank [rankType]="rankTypes.certification" [jobs$]="filteredJobs$"></vgm-rank>
    </section>
  </ng-container>
</main>

<ng-template #desktopTemplate>
  <section class="grid grid-cols-[1fr_2fr] gap-4">
    <div class="flex flex-col gap-2 bg-base-300 rounded-lg">
      <cdk-virtual-scroll-viewport
        class="virtual-scroll-viewport"
        itemSize="500"
        minBufferPx="1000"
        maxBufferPx="2000"
        [appendOnly]="true"
      >
        <button
          *ngFor="let job of filteredJobs$ | async; index as jobIndex; trackBy: trackByJobId"
          class="btn grid grid-cols-[1fr_4fr] w-full h-full p-3 bg-base-100 border-l-4 rounded-l-none hover:border-l-4"
          [ngClass]="
            selectedJob.id === job.id
              ? 'border-l-primary hover:border-l-primary'
              : job.interactionStatus.applied
                ? 'border-l-success hover:border-l-success'
                : job.interactionStatus.discarded
                  ? 'border-l-error hover:border-l-error'
                  : job.interactionStatus.accessed
                    ? 'border-l-info hover:border-l-info'
                    : job.interactionStatus.viewed
                      ? 'border-l-neutral-content hover:border-l-neutral-content'
                      : ''
          "
          (click)="selectJob(job, jobIndex)"
        >
          <div
            *ngIf="job.matchPercentage !== undefined; else jobWithoutMatchPercentageTemplate"
            class="flex flex-col border-2 rounded order-0"
            [ngClass]="{
              'border-success': job.matchPercentage >= 90,
              'border-accent': job.matchPercentage >= 60 && job.matchPercentage < 90,
              'border-warning': job.matchPercentage >= 30 && job.matchPercentage < 60,
              'border-error': job.matchPercentage < 30
            }"
          >
            <span
              class="flex items-center justify-center text-sm p-1 text-black gap-1"
              [ngClass]="{
                'bg-success': job.matchPercentage >= 90,
                'bg-accent': job.matchPercentage >= 60 && job.matchPercentage < 90,
                'bg-warning': job.matchPercentage >= 30 && job.matchPercentage < 60,
                'bg-error': job.matchPercentage < 30
              }"
            >
              <i class="bx bx-analyse"></i>
              MATCH
            </span>
            <span
              class="flex items-center justify-center text-xl p-1 font-bold"
              [ngClass]="{
                'text-success': job.matchPercentage >= 90,
                'text-accent': job.matchPercentage >= 60 && job.matchPercentage < 90,
                'text-warning': job.matchPercentage >= 30 && job.matchPercentage < 60,
                'text-error': job.matchPercentage < 30
              }"
              >{{ job.matchPercentage | number: "1.0-0" }}%</span
            >
          </div>

          <ng-template #jobWithoutMatchPercentageTemplate>
            <div class="flex flex-col border-base-300 border-2 rounded order-0">
              <span class="flex items-center justify-center text-sm p-1 gap-1 bg-base-300">
                <i class="bx bx-analyse"></i>
                MATCH
              </span>
              <span class="flex items-center justify-center text-xl p-1 font-bold bg-base-100"
                >?</span
              >
            </div>
          </ng-template>

          <div class="flex flex-col gap-2 min-w-0">
            <div class="flex flex-col gap-1">
              <span class="text-nowrap overflow-hidden text-ellipsis text-start">{{
                job.title
              }}</span>
              <span
                class="text-sm font-normal text-start text-nowrap overflow-hidden text-ellipsis"
                >{{ job.companyName }}</span
              >
            </div>
            <span class="text-sm font-normal text-start">{{ job.publishedDate | timeAgo }}</span>
          </div>
        </button>
      </cdk-virtual-scroll-viewport>

      <div class="flex flex-col gap-2 p-4">
        <button
          *ngIf="(selectedJobList$ | async) !== jobLists.TO_DECIDE"
          class="btn btn-sm"
          (click)="setJobsListType(jobLists.TO_DECIDE)"
        >
          Ver vagas a decidir
        </button>
        <button
          *ngIf="(selectedJobList$ | async) !== jobLists.APPLIED"
          class="btn btn-sm"
          (click)="setJobsListType(jobLists.APPLIED)"
        >
          Ver vagas aplicadas
        </button>
        <button
          *ngIf="(selectedJobList$ | async) !== jobLists.DISCARDED"
          class="btn btn-sm"
          (click)="setJobsListType(jobLists.DISCARDED)"
        >
          Ver vagas descartadas
        </button>
      </div>
    </div>

    <div class="card bg-base-300 rounded-lg p-4 h-fit">
      <header class="flex justify-between mb-4 card-title">
        <div>
          <div class="flex items-center w-full gap-4 flex-wrap lg:flex-nowrap">
            <div
              *ngIf="
                selectedJob.matchPercentage !== undefined;
                else jobWithoutMatchPercentageTemplate
              "
              class="flex flex-col border-2 rounded order-0"
              [ngClass]="{
                'border-success': selectedJob.matchPercentage >= 90,
                'border-accent':
                  selectedJob.matchPercentage >= 60 && selectedJob.matchPercentage < 90,
                'border-warning':
                  selectedJob.matchPercentage >= 30 && selectedJob.matchPercentage < 60,
                'border-error': selectedJob.matchPercentage < 30
              }"
            >
              <span
                class="flex items-center justify-center text-sm p-1 text-black gap-1"
                [ngClass]="{
                  'bg-success': selectedJob.matchPercentage >= 90,
                  'bg-accent':
                    selectedJob.matchPercentage >= 60 && selectedJob.matchPercentage < 90,
                  'bg-warning':
                    selectedJob.matchPercentage >= 30 && selectedJob.matchPercentage < 60,
                  'bg-error': selectedJob.matchPercentage < 30
                }"
              >
                <i class="bx bx-analyse"></i>
                MATCH
              </span>
              <span
                class="flex items-center justify-center text-xl p-1 font-bold"
                [ngClass]="{
                  'text-success': selectedJob.matchPercentage >= 90,
                  'text-accent':
                    selectedJob.matchPercentage >= 60 && selectedJob.matchPercentage < 90,
                  'text-warning':
                    selectedJob.matchPercentage >= 30 && selectedJob.matchPercentage < 60,
                  'text-error': selectedJob.matchPercentage < 30
                }"
                >{{ selectedJob.matchPercentage | number: "1.0-0" }}%</span
              >
            </div>

            <ng-template #jobWithoutMatchPercentageTemplate>
              <div class="flex flex-col border-base-300 border-2 rounded order-0">
                <span class="flex items-center justify-center text-sm p-1 gap-1 bg-base-300">
                  <i class="bx bx-analyse"></i>
                  MATCH
                </span>
                <span class="flex items-center justify-center text-xl p-1 font-bold bg-base-100"
                  >?</span
                >
              </div>
            </ng-template>

            <div class="order-2 lg:order-1">
              <h1 class="text-start">{{ selectedJob.title }}</h1>
              <div class="flex items-center gap-2">
                <i class="bx bxs-business"></i>

                <a
                  *ngIf="selectedJob.companyUrl; else jobWithoutCompanyUrlTemplate"
                  class="text-slate-300 text-sm link"
                  [href]="selectedJob.companyUrl"
                  >{{ selectedJob.companyName }}</a
                >

                <ng-template #jobWithoutCompanyUrlTemplate>
                  <a class="text-slate-300 text-sm">{{ selectedJob.companyName }}</a>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2 self-start">
          <button
            *ngIf="selectedJob.repostings.length > 0"
            class="btn btn-xs lg:btn-sm btn-outline btn-warning flex-nowrap"
          >
            <i class="bx bx-refresh"></i>
            <span>
              <ng-container
                *ngIf="selectedJob.timeInDaysBetweenRepostings > 1; else singleDayRepostingTemplate"
              >
                Postada {{ selectedJob.repostings.length + 1 }} vezes durante
                {{ selectedJob.timeInDaysBetweenRepostings | number }} dias
              </ng-container>

              <ng-template #singleDayRepostingTemplate>
                Postada {{ selectedJob.repostings.length + 1 }} vezes no mesmo dia
              </ng-template>
            </span>
          </button>

          <div
            *ngIf="selectedJob.publishedDate.toDateString() !== today.toDateString()"
            class="badge badge-warning gap-1 p-4 ml-auto rounded"
          >
            <i class="bx bx-brightness"></i>
            <span> Nova </span>
          </div>
        </div>
      </header>

      <ng-container *ngIf="selectedJob.matchPercentage === undefined">
        <div class="flex items-center gap-2 mb-4 w-full">
          <i class="bx bx-analyse"></i>
          <span>
            Use a
            <a class="btn btn-link p-0 min-h-fit h-fit" [routerLink]="['/busca-facil']"
              >busca f√°cil</a
            >
            para saber o seu match com a vaga!
          </span>
        </div>
      </ng-container>

      <div
        *ngIf="selectedJob.keywords.length > 0; else noTechnologiesTemplate"
        class="flex flex-wrap pb-4 gap-2"
      >
        <div
          *ngFor="let technology of sortedTechnologies"
          class="gap-1 badge badge-outline p-3"
          [ngClass]="
            technology.matchesSearchParameters ? 'badge-warning' : technology.category.badgeClass
          "
        >
          <i *ngIf="technology.matchesSearchParameters" class="bx bxs-star text-sm"></i>
          {{ technology.name }}
        </div>
      </div>

      <ng-template #noTechnologiesTemplate>
        <div class="gap-1 badge badge-ghost badge-outline p-3">
          <span>Nenhuma tecnologia identificada</span>
        </div>
      </ng-template>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-user-detail text-sm"></i>
            <span> N√≠vel de experi√™ncia </span>
          </div>

          <div *ngIf="selectedJob.experienceLevels.length > 0" class="flex flex-wrap gap-2">
            <span
              class="badge badge-neutral p-4 font-bold rounded gap-1"
              *ngFor="let experienceLevel of selectedJob.experienceLevels"
              [ngClass]="{
                'badge-warning': experienceLevel.matchesSearchParameters
              }"
            >
              <i *ngIf="experienceLevel.matchesSearchParameters" class="bx bxs-star text-sm"></i>
              <span>{{ experienceLevel.name }}</span>
            </span>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-home text-sm"></i>
            <span>Modalidade</span>
          </div>

          <div *ngIf="selectedJob.workplaceTypes.length > 0" class="flex flex-wrap gap-2">
            <div
              class="badge badge-neutral p-4 font-bold rounded gap-1"
              *ngFor="let workplaceType of selectedJob.workplaceTypes"
              [ngClass]="{
                'badge-warning': workplaceType.matchesSearchParameters
              }"
            >
              <i *ngIf="workplaceType.matchesSearchParameters" class="bx bxs-star text-sm"></i>
              <span>{{ workplaceType.type }}</span>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-briefcase text-sm"></i>
            <span>Tipo de contrato</span>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <div
              class="badge badge-neutral p-4 font-bold rounded gap-1"
              *ngFor="let contractType of selectedJob.contractTypes"
              [ngClass]="{
                'badge-warning': contractType.matchesSearchParameters
              }"
            >
              <i *ngIf="contractType.matchesSearchParameters" class="bx bxs-star text-sm"></i>
              <span>{{ contractType.type }}</span>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-map text-sm"></i>
            <span>Local</span>
          </div>

          <span class="badge badge-neutral p-4 font-bold rounded gap-1">
            {{
              selectedJob.city ? selectedJob.city + (selectedJob.state | stateAbbreviation) : "N/A"
            }}
          </span>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-calendar text-sm"></i>
            <span>Data de publica√ß√£o</span>
          </div>

          <span class="badge badge-neutral p-4 font-bold rounded gap-1">
            {{ selectedJob.publishedDate | date: "dd/MM/yyyy" }}
          </span>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bx-accessibility text-sm"></i>
            <span>Inclus√£o</span>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <div
              class="badge badge-neutral p-4 font-bold rounded gap-1"
              *ngFor="let inclusionType of selectedJob.inclusionTypes"
              [ngClass]="{
                'badge-warning': inclusionType.matchesSearchParameters
              }"
            >
              <i *ngIf="inclusionType.matchesSearchParameters" class="bx bxs-star text-sm"></i>
              <span>{{ inclusionType.type }}</span>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-graduation text-sm"></i>
            <span>N√≠vel educacional</span>
          </div>

          <ng-container
            *ngIf="
              selectedJob.educationalLevelTerms.length > 0;
              else emptyEducationalLevelsTemplate
            "
          >
            <div class="flex flex-wrap items-center gap-2">
              <div
                class="badge badge-neutral p-4 font-bold rounded gap-1"
                *ngFor="let educacionalLevelTerm of selectedJob.educationalLevelTerms"
              >
                {{ educacionalLevelTerm }}
              </div>
            </div>
          </ng-container>

          <ng-template #emptyEducationalLevelsTemplate>
            <span class="font-bold">Desconhecido</span>
          </ng-template>
        </div>

        <div>
          <div class="flex items-center gap-1 mb-1 text-sm">
            <i class="bx bx-globe text-sm"></i>
            <span>Idiomas</span>
          </div>

          <ng-container *ngIf="selectedJob.languages.length > 0; else emptyLanguagesTemplate">
            <div class="flex items-center gap-2">
              <div
                class="badge badge-neutral p-4 font-bold rounded gap-1"
                *ngFor="let language of selectedJob.languages"
              >
                {{ language }}
              </div>
            </div>
          </ng-container>

          <ng-template #emptyLanguagesTemplate>
            <span class="badge badge-neutral p-4 font-bold rounded gap-1">Desconhecido</span>
          </ng-template>
        </div>

        <div>
          <div class="flex flex-wrap items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-award text-sm"></i>
            <span>Certifica√ß√µes</span>
          </div>

          <div class="flex items-center gap-2">
            <div
              class="badge badge-neutral p-4 font-bold rounded gap-1"
              *ngFor="let certificationStatus of selectedJob.certificationStatuses"
            >
              {{ certificationStatus }}
            </div>
          </div>
        </div>

        <div>
          <div class="flex flex-wrap items-center gap-1 mb-1 text-sm">
            <i class="bx bxs-info-circle text-sm"></i>
            <span>Status</span>
          </div>

          <div class="flex flex-wrap pb-4 gap-2">
            <div
              *ngIf="selectedJob.interactionStatus.viewed"
              class="gap-1 badge badge-neutral p-4 font-bold rounded"
            >
              <span>Vista</span>
            </div>

            <div
              *ngIf="selectedJob.interactionStatus.accessed"
              class="gap-1 badge badge-info p-4 font-bold rounded"
            >
              <span>Acessada</span>
            </div>

            <div
              *ngIf="selectedJob.interactionStatus.applied"
              class="gap-1 badge badge-success p-4 font-bold rounded"
            >
              <span>Aplicada</span>
            </div>

            <div
              *ngIf="selectedJob.interactionStatus.discarded"
              class="gap-1 badge badge-error p-4 font-bold rounded"
            >
              <span>Descartada</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-actions flex-col mt-4">
        <div class="flex w-full gap-2">
          <a class="flex items-center gap-2 flex-1" [href]="selectedJob.jobUrl" target="_blank">
            <button class="btn btn-info flex-1" (click)="setJobAsAccessed()">
              <i class="bx bx-link-external"></i>
              <span>Acessar vaga</span>
            </button>
          </a>

          <button class="btn btn-success flex-1" (click)="setJobAsApplied()">
            <i class="bx bxs-check-square"></i>
            <span>Marcar como aplicada</span>
          </button>

          <button class="btn btn-error flex-1" (click)="setJobAsDiscarded()">
            <i class="bx bxs-x-square"></i>
            <span>Marcar como descartada</span>
          </button>
        </div>

        <button class="btn w-full flex-1">
          <span>Pr√≥xima vaga</span>
          <i class="bx bx-chevrons-right"></i>
        </button>
      </div>
    </div>
  </section>
</ng-template>
